// app/ai/page.tsx
export const revalidate = 10800; // 3 ore

import { cookies } from "next/headers";
import AuthGuard from "@/components/AuthGuard";
import {
  getAIInvestmentIdeas,
  type InvestmentIdea,
  type AIResult,
} from "../../lib/AiAdvisor";
import type { Quote } from "../../lib/marketData";
import AiIdeaCard from "../../components/AiIdeaCard";
import { normalizeLang } from "../../lib/i18n";

// trova il prezzo per un dato ticker (se Finnhub lo ha dato)
function findQuote(ticker: string, prices: Quote[]): Quote | undefined {
  return prices.find((q) => q.ticker === ticker);
}

export type InvestmentIdeaWithPrice = InvestmentIdea & {
  priceNow: number | null;
};

// testi header/disclaimer per lingua
const AI_TEXTS: Record<
  string,
  { title: string; subtitle: string; disclaimer: string }
> = {
  it: {
    title: "Quantivo AI",
    subtitle:
      "Le stime di performance (1 giorno, 1 settimana, 1 mese) sono generate da un modello AI su dati storici di indici, azioni e crypto, solo a scopo educativo.",
    disclaimer:
      "Le percentuali e i target mostrati sono stime ipotetiche generate da un modello AI allenato con oltre 500 indici storici. Non sono raccomandazioni di investimento.",
  },
  en: {
    title: "Quantivo AI",
    subtitle:
      "Performance estimates (1 day, 1 week, 1 month) are generated by an AI model on historical data for indices, stocks and crypto.",
    disclaimer:
      "Percentages and targets shown are hypothetical estimates generated by an AI model for educational purposes only. They are not real market forecasts nor investment recommendations.",
  },
  zh: {
    title: "Quantivo AI",
    subtitle:
      "ç»©æ•ˆé¢„ä¼°ï¼ˆ1 å¤©ã€1 å‘¨ã€1 ä¸ªæœˆï¼‰ç”± AI æ¨¡åž‹åŸºäºŽæŒ‡æ•°ã€è‚¡ç¥¨å’ŒåŠ å¯†èµ„äº§çš„åŽ†å²æ•°æ®ç”Ÿæˆï¼Œä»…ä¾›å­¦ä¹ å‚è€ƒï¼Œä¸æž„æˆæŠ•èµ„å»ºè®®ã€‚",
    disclaimer:
      "é¡µé¢ä¸­çš„ç™¾åˆ†æ¯”å’Œç›®æ ‡ä»·æ ¼åªæ˜¯ç”± AI æ¨¡åž‹ç”Ÿæˆçš„å‡è®¾æ€§ç¤ºä¾‹ï¼Œä»…ç”¨äºŽæ•™è‚²ç›®çš„ï¼Œä¸æž„æˆçœŸå®žå¸‚åœºé¢„æµ‹æˆ–ä»»ä½•æŠ•èµ„å»ºè®®ã€‚",
  },
};

export default async function AiPage() {
  // âœ… cookies() puÃ² essere sync o async a seconda della versione:
  // uso await + cast any cosÃ¬ non mi interessa la firma esatta
  const cookieStore: any = await (cookies() as any);
  const cookieValue: string =
    cookieStore?.get?.("quantivo-lang")?.value ?? "en";

  const lang = normalizeLang(cookieValue); // es. "it", "en", "zh", ...

  // ðŸ“Š chiamo l'AI passando la lingua â†’ le "reason" arrivano giÃ  tradotte
  const data: AIResult = await getAIInvestmentIdeas(lang);
  const text = AI_TEXTS[lang] ?? AI_TEXTS["en"];

  const ideasWithPrice: InvestmentIdeaWithPrice[] = data.ideas.map(
    (idea: InvestmentIdea) => {
      const quote = findQuote(idea.ticker, data.prices);
      const priceNow = quote?.price ?? null;

      return {
        ...idea,
        priceNow,
      };
    }
  );

  return (
    <AuthGuard>
      <div className="space-y-4 p-5">
        <header className="space-y-1">
          <h1 className="text-2xl font-semibold">{text.title}</h1>
          <p className="text-xs text-slate-400">{text.subtitle}</p>
        </header>

        <section className="space-y-3">
          {ideasWithPrice.map((idea, i) => (
            <AiIdeaCard key={idea.ticker + i} idea={idea} />
          ))}
        </section>

        <p className="pt-4 text-[10px] text-slate-500">{text.disclaimer}</p>
      </div>
    </AuthGuard>
  );
}
